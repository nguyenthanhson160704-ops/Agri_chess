<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cá» NÃ´ng Nghiá»‡p - GV: Nguyá»…n ThÃ nh SÆ¡n</title>
    <style>
        :root {
            --primary-green: #2E7D32;
            --grass: #8BC34A;
            --soil: #5D4037;
            --wood: #8D6E63;
            --sky: #E3F2FD;
            --corn: #FBC02D;
            --coco: #4E342E;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--sky);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: #2c3e50;
        }

        /* TABS */
        .tabs { margin-top: 15px; display: flex; gap: 5px; }
        .tab-btn { 
            padding: 10px 25px; border: none; cursor: pointer; 
            background: var(--soil); color: white; border-radius: 15px 15px 0 0;
            font-weight: bold; transition: 0.3s;
        }
        .tab-btn.active { background: var(--primary-green); transform: translateY(-3px); }

        .container {
            background: #fff; width: 95%; max-width: 1300px;
            min-height: 700px; padding: 20px;
            border: 8px solid var(--soil); border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            position: relative;
        }

        .hidden { display: none !important; }

        /* Báº¢NG NHáº¬P CÃ‚U Há»I */
        .q-setup-table { width: 100%; border-collapse: collapse; background: #fff; }
        .q-setup-table th { background: var(--wood); color: white; padding: 12px; }
        .q-setup-table td { padding: 8px; border-bottom: 1px solid #ddd; text-align: center; }
        .q-input-text { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .radio-custom { transform: scale(1.5); cursor: pointer; }

        /* SCOREBOARD */
        .scoreboard { display: flex; justify-content: space-around; margin-bottom: 20px; gap: 20px; }
        .team-card { flex: 1; padding: 15px; border-radius: 15px; border: 4px solid #ddd; background: #f9f9f9; text-align: center; transition: 0.3s; }
        .active-team { border-color: var(--primary-green); background: #e8f5e9; transform: scale(1.02); }
        .player-name { font-size: 1.4rem; font-weight: bold; color: #d32f2f; min-height: 30px; }

        /* GAME AREA */
        .game-area { display: flex; gap: 30px; }
        .question-side { flex: 1.4; display: flex; flex-direction: column; gap: 20px; }
        .q-box {
            background: #fff; border: 6px solid var(--primary-green);
            border-radius: 20px; padding: 40px; flex-grow: 1;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center;
        }
        .q-text { font-size: 2.8rem; font-weight: 800; color: #333; line-height: 1.3; margin-bottom: 30px; }
        .timer-circle { font-size: 2rem; font-weight: bold; color: #e53935; margin-bottom: 10px; }

        .board-side { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .farm-frame { background: #4e342e; padding: 15px; border-radius: 15px; border: 5px solid #3e2723; }
        .board { display: grid; grid-template-columns: 50px repeat(5, 75px); gap: 6px; background: #5d4037; }
        .cell-label { height: 75px; display: flex; align-items: center; justify-content: center; background: var(--wood); color: white; font-weight: bold; font-size: 1.5rem; border-radius: 5px; }
        .cell { height: 75px; background: #aed581; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; transition: 0.2s; position: relative; }
        .cell.taken { cursor: not-allowed; background: #9ccc65; }

        /* MÃ€U THáº®NG Lá»¢I */
        .line-color-0 { background-color: #ffeb3b !important; box-shadow: 0 0 20px #fbc02d; border: 2px solid white; }
        .line-color-1 { background-color: #ff9800 !important; box-shadow: 0 0 20px #ef6c00; border: 2px solid white; }
        .line-color-2 { background-color: #e040fb !important; box-shadow: 0 0 20px #aa00ff; border: 2px solid white; }
        .line-color-3 { background-color: #00e676 !important; box-shadow: 0 0 20px #00c853; border: 2px solid white; }
        .line-color-4 { background-color: #ff4081 !important; box-shadow: 0 0 20px #f50057; border: 2px solid white; }

        .win-active .char { animation: win-jump 0.4s infinite !important; }
        @keyframes win-jump { 0%, 100% { transform: translateY(0) scale(1.1); } 50% { transform: translateY(-20px) scale(1.3); } }

        /* BUTTONS */
        .btn { padding: 15px 30px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; }
        .btn-roll { background: #ff9800; width: 100%; font-size: 1.5rem; margin-bottom: 20px; }
        .btn-yes { background: var(--grass); flex: 1; font-size: 1.5rem; }
        .btn-no { background: #e53935; flex: 1; font-size: 1.5rem; }
        .btn-save { background: var(--primary-green); padding: 20px 60px; font-size: 1.5rem; }
        
        .char { display: inline-block; animation: hop 1.5s infinite; transition: 0.3s; }
        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* VOLUME SLIDERS */
        .vol-section { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .vol-label { min-width: 140px; font-weight: bold; }
        input[type="range"] { cursor: pointer; accent-color: var(--primary-green); flex-grow: 1; }

        #music-control { position: fixed; bottom: 20px; right: 20px; background: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100; font-size: 1.5rem; }

        /* CSS XÃšC Xáº®C 3D */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: 0.5s; }
        .dice-scene { width: 200px; height: 200px; perspective: 600px; margin: 40px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-100px); transition: transform 3s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .cube-face { position: absolute; width: 200px; height: 200px; border: 4px solid #fff; line-height: 200px; font-size: 24px; font-weight: bold; text-align: center; background: #fff; color: #333; border-radius: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.2); }
        .cube-face-1 { transform: rotateY(  0deg) translateZ(100px); background: #FFEB3B; }
        .cube-face-2 { transform: rotateY( 90deg) translateZ(100px); background: #4CAF50; color: white; }
        .cube-face-3 { transform: rotateY(180deg) translateZ(100px); background: #FFEB3B; }
        .cube-face-4 { transform: rotateY(-90deg) translateZ(100px); background: #4CAF50; color: white; }
        .cube-face-5 { transform: rotateX( 90deg) translateZ(100px); background: #FFEB3B; }
        .cube-face-6 { transform: rotateX(-90deg) translateZ(100px); background: #4CAF50; color: white; }
    </style>
</head>
<body>

    <div id="dice-overlay" class="overlay hidden">
        <h1 id="dice-status" style="font-size: 2.5rem;">AI Sáº¼ ÄI TRÆ¯á»šC?</h1>
        <div class="dice-scene">
            <div id="cube" class="cube">
                <div class="cube-face cube-face-1">Äá»˜I BÃ‰ NGÃ”</div>
                <div class="cube-face cube-face-2">Äá»˜I BÃ‰ Dá»ªA</div>
                <div class="cube-face cube-face-3">Äá»˜I BÃ‰ NGÃ”</div>
                <div class="cube-face cube-face-4">Äá»˜I BÃ‰ Dá»ªA</div>
                <div class="cube-face cube-face-5">Äá»˜I BÃ‰ NGÃ”</div>
                <div class="cube-face cube-face-6">Äá»˜I BÃ‰ Dá»ªA</div>
            </div>
        </div>
        <button class="btn btn-save" id="start-roll-btn" onclick="rollDice()">ğŸ² TUNG XÃšC Xáº®C</button>
    </div>

    <div id="music-control" onclick="toggleMusic()">ğŸ”‡</div>
    
    <div style="text-align: center; margin: 10px 0;">
        <h1 style="color: var(--primary-green); text-shadow: 2px 2px #fff; margin: 0;">ğŸŒ¾ Cá»œ NÃ”NG NGHIá»†P ğŸŒ¾</h1>
        <p style="font-size: 1.2rem; font-weight: bold; color: var(--soil); margin: 5px 0;">GV: Nguyá»…n ThÃ nh SÆ¡n</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" id="t-setup" onclick="showTab('setup')">âš™ï¸ CÃ€I Äáº¶T</button>
        <button class="tab-btn" id="t-game" onclick="showTab('game')">ğŸ® VÃ€O TRáº¬N</button>
        <button class="tab-btn" id="t-result" onclick="showTab('result')">ğŸ† Káº¾T QUáº¢</button>
    </div>

    <div class="container" id="tab-setup">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div style="background: #fff9c4; padding: 20px; border-radius: 15px; border: 4px solid var(--corn);">
                <h3>ğŸŸ¡ Äá»˜I BÃ‰ NGÃ” ğŸŒ½</h3>
                <input type="text" id="t1-n" value="Äá»™i NgÃ´ Xanh" style="width:95%; padding:10px; margin-bottom:10px;">
                <textarea id="t1-m" style="width:95%; height:80px;">An&#10;BÃ¬nh&#10;Chi</textarea>
            </div>
            <div style="background: #e1f5fe; padding: 20px; border-radius: 15px; border: 4px solid #03a9f4;">
                <h3>ğŸŸ¢ Äá»˜I BÃ‰ Dá»ªA ğŸ¥¥</h3>
                <input type="text" id="t2-n" value="Äá»™i Dá»«a Ngá»t" style="width:95%; padding:10px; margin-bottom:10px;">
                <textarea id="t2-m" style="width:95%; height:80px;">DÅ©ng&#10;Em&#10;Giang</textarea>
            </div>
        </div>

        <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; border: 2px dashed var(--soil);">
                <h3>ğŸµ NHáº C Ná»€N TÃ™Y CHá»ˆNH</h3>
                <input type="file" id="music-upload" accept="audio/mp3" style="width: 100%; margin-bottom: 10px;">
                <div class="vol-section">
                    <span class="vol-label">Ã‚m lÆ°á»£ng nháº¡c:</span>
                    <input type="range" id="vol-music" min="0" max="1" step="0.05" value="0.5" oninput="updateMusicVolume()">
                </div>
            </div>
            <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; border: 2px dashed var(--soil);">
                <h3>ğŸ”” HIá»†U á»¨NG TRÃ’ CHÆ I</h3>
                <div class="vol-section">
                    <span class="vol-label">Ã‚m bÃ¡o game:</span>
                    <input type="range" id="vol-sfx" min="0" max="1" step="0.05" value="0.5">
                </div>
            </div>
        </div>
        
        <div style="margin-top:20px;">
            <h3>ğŸ“ Báº¢NG CÃ‚U Há»I ÄÃšNG/SAI (Tá»I ÄA 16 CÃ‚U)</h3>
            <div style="max-height: 200px; overflow-y: auto; border: 2px solid var(--wood); border-radius: 10px;">
                <table class="q-setup-table">
                    <thead>
                        <tr><th width="5%">STT</th><th width="75%">CÃ¢u há»i</th><th width="10%">ÄÃºng âœ…</th><th width="10%">Sai âŒ</th></tr>
                    </thead>
                    <tbody id="q-table-body"></tbody>
                </table>
            </div>
            <center style="margin-top: 10px;">
                <button class="btn" style="background: #2196F3;" onclick="loadSampleQuestions()">ğŸ’¡ NHáº¬P CÃ‚U Há»I MáºªU</button>
                <button class="btn" style="background: #f44336;" onclick="clearSavedData()">ğŸ—‘ï¸ XÃ“A Dá»® LIá»†U ÄÃƒ LÆ¯U</button>
            </center>
        </div>
        
        <center style="margin-top: 20px;"><button class="btn btn-save" onclick="triggerDiceOverlay()">ğŸ’¾ LÆ¯U VÃ€ Báº®T Äáº¦U</button></center>
    </div>

    <div class="container hidden" id="tab-game">
        <div class="scoreboard">
            <div class="team-card" id="card-0">
                <h2 id="v-n0">Äá»˜I BÃ‰ NGÃ”</h2>
                <div class="player-name" id="v-p0">---</div>
                <div style="font-size: 1.5rem;">Sá»‘ Ã´: <b id="v-s0">0</b></div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; font-weight: bold;">CÃ‚U Há»I</div>
                <div style="font-size: 2.5rem; font-weight: 900;" id="v-qcount">1/16</div>
            </div>
            <div class="team-card" id="card-1">
                <h2 id="v-n1">Äá»˜I BÃ‰ Dá»ªA</h2>
                <div class="player-name" id="v-p1">---</div>
                <div style="font-size: 1.5rem;">Sá»‘ Ã´: <b id="v-s1">0</b></div>
            </div>
        </div>

        <div class="game-area">
            <div class="question-side">
                <button class="btn btn-roll" id="roll-btn" onclick="spinPlayer()">ğŸ² XOAY TÃŠN NGÆ¯á»œI TRáº¢ Lá»œI</button>
                <div class="q-box" id="q-panel">
                    <div class="timer-circle" id="timer">â±ï¸ 15s</div>
                    <div class="q-text" id="q-display">Äang chá» gieo háº¡t...</div>
                    <div id="q-ans-box" class="hidden" style="display: flex; gap: 20px; width: 100%;">
                        <button class="btn btn-yes" onclick="ans(true)">âœ… ÄÃšNG</button>
                        <button class="btn btn-no" onclick="ans(false)">âŒ SAI</button>
                    </div>
                </div>
                <div id="status-msg" style="text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--primary-green);">...</div>
            </div>

            <div class="board-side">
                <div class="farm-frame">
                    <div class="board" id="main-board"></div>
                </div>
                <div style="margin-top: 40px; display: flex; gap: 30px;">
                    <div id="char0" class="char" style="font-size: 4rem;">ğŸŒ½</div>
                    <div id="char1" class="char" style="font-size: 4rem; opacity: 0.2;">ğŸ¥¥</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container hidden" id="tab-result">
        <center>
            <h1 style="font-size: 4rem;">ğŸ‰ Káº¾T THÃšC ğŸ‰</h1>
            <div id="final-summary" style="display: flex; justify-content: center; gap: 50px; margin: 40px 0;"></div>
            <div id="winner-txt" style="font-size: 3rem; font-weight: 900; color: var(--primary-green); margin-bottom: 40px;"></div>
            <button class="btn btn-save" onclick="location.reload()">ğŸ”„ CHÆ I Láº I</button>
        </center>
    </div>

    <audio id="bg-audio" loop></audio>

    <script>
        // --- Ã‚M THANH & NHáº C ---
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        let musicPlaying = false, musicLoop;
        const bgAudio = document.getElementById('bg-audio');

        function play(f, t='sine', v=0.1, d=0.5) {
            if (ctx.state === 'suspended') ctx.resume();
            const volSfx = document.getElementById('vol-sfx').value;
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.type = t; o.connect(g); g.connect(ctx.destination);
            o.frequency.setValueAtTime(f, ctx.currentTime);
            g.gain.setValueAtTime(v * volSfx, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + d);
            o.start(); o.stop(ctx.currentTime + d);
        }

        document.getElementById('music-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) { bgAudio.src = URL.createObjectURL(file); updateMusicVolume(); }
        });

        function updateMusicVolume() { bgAudio.volume = document.getElementById('vol-music').value; }

        function toggleMusic() {
            musicPlaying = !musicPlaying;
            document.getElementById('music-control').innerText = musicPlaying ? "ğŸ”Š" : "ğŸ”‡";
            if (musicPlaying) {
                if (ctx.state === 'suspended') ctx.resume();
                if (bgAudio.src) bgAudio.play(); else startBGM();
            } else { bgAudio.pause(); clearInterval(musicLoop); }
        }

        function startBGM() {
            const notes = [261.63, 329.63, 392.00, 523.25, 392.00, 329.63];
            let i = 0; musicLoop = setInterval(() => { 
                const volMusic = document.getElementById('vol-music').value;
                play(notes[i % notes.length], 'triangle', 0.04 * volMusic, 0.8); i++; 
            }, 600);
        }

        // --- RENDER Báº¢NG NHáº¬P ---
        const tableBody = document.getElementById('q-table-body');
        for(let i=1; i<=16; i++) {
            tableBody.innerHTML += `<tr><td>${i}</td><td><input type="text" class="q-input-text" id="qi-${i}" placeholder="Nháº­p cÃ¢u há»i..."></td><td><input type="radio" name="qa-${i}" value="true" class="radio-custom" checked></td><td><input type="radio" name="qa-${i}" value="false" class="radio-custom"></td></tr>`;
        }

        function loadSampleQuestions() {
            const samples = ["LÃºa lÃ  cÃ¢y lÆ°Æ¡ng thá»±c?","BÃ² cÃ³ 4 dáº¡ dÃ y?","CÃ  phÃª lÃ  cÃ¢y lÃ¢u nÄƒm?","Dá»«a cÃ³ thá»ƒ náº£y máº§m?","VN á»Ÿ ChÃ¢u Má»¹?","1+1=2?","Máº·t trá»i má»c hÆ°á»›ng ÄÃ´ng?","Con gÃ  Ä‘áº» trá»©ng?","HÃ  Ná»™i lÃ  thá»§ Ä‘Ã´?","Kiáº¿n cÃ³ cÃ¡nh?","NÆ°á»›c sÃ´i 100 Ä‘á»™?","Chuá»‘i chÃ­n mÃ u xanh?","1 nÄƒm cÃ³ 12 thÃ¡ng?","TrÃ¡i Ä‘áº¥t hÃ¬nh trÃ²n?","Con cÃ¡ biáº¿t bay?","Há»• lÃ  Ä‘á»™ng váº­t Äƒn thá»‹t?"];
            const ans = [true, true, true, true, false, true, true, true, true, false, true, false, true, true, false, true];
            for(let i=1; i<=16; i++) { document.getElementById(`qi-${i}`).value = samples[i-1]; document.getElementsByName(`qa-${i}`)[ans[i-1] ? 0 : 1].checked = true; }
        }

        function autoSave() {
            const gameData = {
                t1n: document.getElementById('t1-n').value, t1m: document.getElementById('t1-m').value,
                t2n: document.getElementById('t2-n').value, t2m: document.getElementById('t2-m').value,
                volMusic: document.getElementById('vol-music').value, volSfx: document.getElementById('vol-sfx').value,
                questions: []
            };
            for(let i=1; i<=16; i++) gameData.questions.push({ text: document.getElementById(`qi-${i}`).value, ans: document.getElementsByName(`qa-${i}`)[0].checked });
            localStorage.setItem('coNongNghiepData', JSON.stringify(gameData));
        }

        window.onload = function() {
            const savedData = localStorage.getItem('coNongNghiepData');
            if(savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('t1-n').value = data.t1n; document.getElementById('t1-m').value = data.t1m;
                document.getElementById('t2-n').value = data.t2n; document.getElementById('t2-m').value = data.t2m;
                document.getElementById('vol-music').value = data.volMusic; document.getElementById('vol-sfx').value = data.volSfx;
                data.questions.forEach((q, i) => { if (document.getElementById(`qi-${i+1}`)) { document.getElementById(`qi-${i+1}`).value = q.text; document.getElementsByName(`qa-${i+1}`)[q.ans ? 0 : 1].checked = true; }});
            }
        };

        function clearSavedData() { if(confirm("XÃ³a dá»¯ liá»‡u Ä‘Ã£ lÆ°u?")) { localStorage.removeItem('coNongNghiepData'); location.reload(); } }

        // --- GAME LOGIC ---
        let state = { teams: [{}, {}], qs: [], idx: 0, turn: 0, board: Array(25).fill(null), canTick: false, time: 15, tInterval: null };

        function showTab(id) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.getElementById('t-'+id).classList.add('active');
        }

        // --- TUNG XÃšC Xáº®C ---
        function triggerDiceOverlay() {
            autoSave();
            state.qs = [];
            for(let i=1; i<=16; i++) {
                const qT = document.getElementById(`qi-${i}`).value.trim();
                if(qT) state.qs.push({ q: qT, a: document.getElementsByName(`qa-${i}`)[0].checked });
            }
            if(state.qs.length === 0) return alert("Nháº­p Ã­t nháº¥t 1 cÃ¢u há»i!");
            
            document.getElementById('dice-overlay').classList.remove('hidden');
            document.getElementById('dice-status').innerText = "AI Sáº¼ ÄI TRÆ¯á»šC?";
            document.getElementById('cube').style.transform = `translateZ(-100px) rotateX(0deg) rotateY(0deg)`;
            document.getElementById('start-roll-btn').classList.remove('hidden');
        }

        function rollDice() {
            document.getElementById('start-roll-btn').classList.add('hidden');
            const cube = document.getElementById('cube');
            const result = Math.floor(Math.random() * 6) + 1; // 1-6
            
            // Xoay xÃºc xáº¯c
            const rotations = {
                1: 'rotateY(0deg)', 2: 'rotateY(-90deg)', 3: 'rotateY(-180deg)',
                4: 'rotateY(90deg)', 5: 'rotateX(-90deg)', 6: 'rotateX(90deg)'
            };
            
            cube.style.transform = `translateZ(-100px) rotateX(720deg) rotateY(720deg) ${rotations[result]}`;
            play(600, 'square', 0.1, 1);

            setTimeout(() => {
                state.turn = (result % 2 === 1) ? 0 : 1; // 1,3,5 lÃ  NgÃ´(0), 2,4,6 lÃ  Dá»«a(1)
                const teamName = state.turn === 0 ? document.getElementById('t1-n').value : document.getElementById('t2-n').value;
                document.getElementById('dice-status').innerText = `CHÃšC Má»ªNG: ${teamName.toUpperCase()} ÄI TRÆ¯á»šC!`;
                play(880);
                
                setTimeout(() => {
                    document.getElementById('dice-overlay').classList.add('hidden');
                    initGame();
                }, 2000);
            }, 3500);
        }

        function initGame() {
            state.teams[0] = { n: document.getElementById('t1-n').value, m: document.getElementById('t1-m').value.split('\n').filter(x=>x.trim()), s: 0 };
            state.teams[1] = { n: document.getElementById('t2-n').value, m: document.getElementById('t2-m').value.split('\n').filter(x=>x.trim()), s: 0 };
            document.getElementById('v-n0').innerText = state.teams[0].n;
            document.getElementById('v-n1').innerText = state.teams[1].n;
            buildBoard(); showTab('game'); updateUI();
        }

        function buildBoard() {
            const b = document.getElementById('main-board'); b.innerHTML = '';
            ['', 'A', 'B', 'C', 'D', 'E'].forEach(l => b.innerHTML += `<div class="cell-label cell-top">${l}</div>`);
            for(let i=0; i<5; i++) {
                b.innerHTML += `<div class="cell-label">${i+1}</div>`;
                for(let j=0; j<5; j++) b.innerHTML += `<div class="cell" id="c-${i*5+j}" onclick="tick(${i*5+j})"></div>`;
            }
        }

        function spinPlayer() {
            document.getElementById('roll-btn').disabled = true;
            let c = 0; const team = state.teams[state.turn];
            const iv = setInterval(() => {
                document.getElementById('v-p'+state.turn).innerText = "ğŸ² " + team.m[Math.floor(Math.random()*team.m.length)];
                play(400 + Math.random()*400, 'square', 0.05, 0.1);
                if(++c > 12) { clearInterval(iv); showQ(); }
            }, 80);
        }

        function showQ() {
            const q = state.qs[state.idx];
            document.getElementById('q-display').innerText = q.q;
            document.getElementById('q-ans-box').classList.remove('hidden');
            document.getElementById('v-qcount').innerText = `${state.idx+1}/${state.qs.length}`;
            state.time = 15; // 15 GIÃ‚Y THEO YÃŠU Cáº¦U
            clearInterval(state.tInterval);
            state.tInterval = setInterval(() => {
                state.time--; document.getElementById('timer').innerText = `â±ï¸ ${state.time}s`;
                if(state.time <= 0) ans(!state.qs[state.idx].a);
            }, 1000);
        }

        function ans(u) {
            clearInterval(state.tInterval); document.getElementById('q-ans-box').classList.add('hidden');
            if(u === state.qs[state.idx].a) { play(880); state.canTick = true; document.getElementById('status-msg').innerText = "ÄÃšNG!"; } 
            else { play(150, 'sawtooth'); document.getElementById('q-panel').classList.add('shake'); document.getElementById('status-msg').innerText = "SAI Rá»’I!"; setTimeout(next, 1500); }
        }

        function tick(i) {
            if(!state.canTick || state.board[i] !== null) return;
            state.board[i] = state.turn; state.teams[state.turn].s++;
            state.canTick = false; play(1046); render(); checkWinLines(); setTimeout(next, 1000);
        }

        function checkWinLines() {
            const b = state.board;
            const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
            const colors = ['line-color-0', 'line-color-1', 'line-color-2', 'line-color-3', 'line-color-4'];
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('win-active', ...colors));
            let lineC = 0;
            lines.forEach(line => {
                let team = null; let streak = [];
                for(let idx of line) {
                    if(b[idx] !== null && (team === null || b[idx] === team)) { team = b[idx]; streak.push(idx); } 
                    else { if(streak.length >= 3) { highlightS(streak, colors[lineC++ % 5]); } team = b[idx]; streak = b[idx] !== null ? [idx] : []; }
                }
                if(streak.length >= 3) highlightS(streak, colors[lineC++ % 5]);
            });
        }
        function highlightS(s, c) { s.forEach(idx => document.getElementById('c-'+idx).classList.add('win-active', c)); }

        function getMult(p) {
            const b = state.board; let maxC = 0;
            const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
            lines.forEach(line => { let c = 0; line.forEach(idx => { if(b[idx]===p) { c++; if(c>maxC) maxC=c; } else c=0; }); });
            if(maxC>=5) return { c:maxC, m:4 }; if(maxC===4) return { c:maxC, m:3 }; if(maxC===3) return { c:maxC, m:2 }; return { c:maxC, m:1 };
        }

        function render() {
            for(let i=0; i<25; i++) {
                const c = document.getElementById('c-'+i);
                if(state.board[i] === 0) c.innerHTML = '<span class="char">ğŸŒ½</span>';
                if(state.board[i] === 1) c.innerHTML = '<span class="char">ğŸ¥¥</span>';
            }
            document.getElementById('v-s0').innerText = state.teams[0].s;
            document.getElementById('v-s1').innerText = state.teams[1].s;
        }

        function next() {
            state.idx++; if(state.idx >= state.qs.length) return end();
            state.turn = state.turn === 0 ? 1 : 0; updateUI();
            document.getElementById('roll-btn').disabled = false;
            document.getElementById('q-display').innerText = "Chá» lÆ°á»£t tiáº¿p theo...";
            document.getElementById('v-p0').innerText = "---"; document.getElementById('v-p1').innerText = "---";
        }

        function updateUI() {
            document.getElementById('card-0').className = 'team-card' + (state.turn === 0 ? ' active-team' : '');
            document.getElementById('card-1').className = 'team-card' + (state.turn === 1 ? ' active-team' : '');
            document.getElementById('char0').style.opacity = state.turn === 0 ? "1" : "0.2";
            document.getElementById('char1').style.opacity = state.turn === 1 ? "1" : "0.2";
        }

        function end() {
            showTab('result');
            const r0 = getMult(0), r1 = getMult(1);
            const s0 = state.teams[0].s * r0.m, s1 = state.teams[1].s * r1.m;
            document.getElementById('final-summary').innerHTML = `<div class="team-card"><h2>ğŸŒ½ ${state.teams[0].n}</h2><p>Ã”: ${state.teams[0].s}</p><p>Há»‡ sá»‘: x${r0.m}</p><h3>Tá»”NG: ${s0}</h3></div><div class="team-card"><h2>ğŸ¥¥ ${state.teams[1].n}</h2><p>Ã”: ${state.teams[1].s}</p><p>Há»‡ sá»‘: x${r1.m}</p><h3>Tá»”NG: ${s1}</h3></div>`;
            let w = s0 > s1 ? state.teams[0].n : (s1 > s0 ? state.teams[1].n : "HÃ’A");
            document.getElementById('winner-txt').innerText = s0 === s1 ? "ğŸ¤ Káº¾T QUáº¢ HÃ’A!" : `ğŸ† ${w.toUpperCase()} THáº®NG!`;
        }
    </script>
</body>
</html>